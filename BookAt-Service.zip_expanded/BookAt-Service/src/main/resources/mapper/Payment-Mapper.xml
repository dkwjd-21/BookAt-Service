<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookat.mapper.PaymentMapper">

  <resultMap id="PaymentMap" type="com.bookat.dto.PaymentDto">
    <id property="paymentId" column="payment_id"/>
    <result property="orderId" column="order_id"/>
    <result property="totalPrice" column="total_price"/>
    <result property="paymentPrice" column="payment_price"/>
    <result property="paymentMethod" column="payment_method"/>
    <result property="paymentStatus" column="payment_status"/>
    <result property="paymentDate" column="payment_date"/>
    <result property="paymentInfo" column="payment_info"/>
    <result property="merchantUid" column="merchant_uid"/>
    <result property="impUid" column="imp_uid"/>
    <result property="pgTid" column="pg_tid"/>
    <result property="receiptUrl" column="receipt_url"/>
    <result property="failReason" column="fail_reason"/>
  </resultMap>

  <select id="findById" parameterType="long" resultMap="PaymentMap">
    SELECT * FROM PAYMENT WHERE payment_id = #{paymentId}
  </select>

  <select id="findByMerchantUid" parameterType="string" resultMap="PaymentMap">
    SELECT * FROM PAYMENT WHERE merchant_uid = #{merchantUid}
  </select>

<insert id="insert" parameterType="com.bookat.dto.PaymentDto">
  INSERT INTO PAYMENT (
    payment_id,
    order_id,
    total_price,
    payment_price,
    payment_method,
    payment_status,
    payment_date,
    payment_info,
    merchant_uid
  )
  VALUES (
    SEQ_PAYMENT.NEXTVAL,
    #{orderId, jdbcType=NUMERIC},
    #{totalPrice},
    #{paymentPrice},
    #{paymentMethod},
    #{paymentStatus},
    SYSDATE,
    #{paymentInfo},
    #{merchantUid}
  )
</insert>

  <update id="markPaidByMerchantUid" parameterType="map">
    UPDATE PAYMENT SET
      payment_status = 1,
      imp_uid = #{impUid},
      pg_tid = #{pgTid},
      receipt_url = #{receiptUrl}
    WHERE merchant_uid = #{merchantUid}
  </update>

  <update id="markFailedByMerchantUid" parameterType="map">
    UPDATE PAYMENT SET
      payment_status = -1,
      fail_reason = #{failReason}
    WHERE merchant_uid = #{merchantUid}
  </update>
  
  <update id="markCanceledByMerchantUid">
  UPDATE PAYMENT
     SET payment_status = 3,               -- CANCELED
         fail_reason    = #{reason},       -- 취소 사유 기록
         receipt_url    = #{receiptUrl},   -- 취소 영수증(있으면)
         payment_date   = SYSDATE          -- 타임스탬프 갱신
   WHERE merchant_uid   = #{merchantUid}
</update>
  
</mapper>