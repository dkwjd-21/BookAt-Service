<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookat.mapper.PaymentMapper">

  <resultMap id="PaymentMap" type="com.bookat.dto.PaymentDto">
    <id property="paymentId" column="payment_id"/>
    <result property="orderId" column="order_id"/>
    <result property="totalPrice" column="total_price"/>
    <result property="paymentPrice" column="payment_price"/>
    <result property="paymentMethod" column="payment_method"/>
    <result property="paymentStatus" column="payment_status"/>
    <result property="paymentDate" column="payment_date"/>
    <result property="paymentInfo" column="payment_info"/>
    <result property="merchantUid" column="merchant_uid"/>
    <result property="impUid" column="imp_uid"/>
    <result property="pgTid" column="pg_tid"/>
    <result property="receiptUrl" column="receipt_url"/>
    <result property="failReason" column="fail_reason"/>
  </resultMap>

  <select id="findById" parameterType="long" resultMap="PaymentMap">
    SELECT * FROM PAYMENT WHERE payment_id = #{paymentId}
  </select>

  <select id="findByMerchantUid" parameterType="string" resultMap="PaymentMap">
    SELECT * FROM PAYMENT WHERE merchant_uid = #{merchantUid}
  </select>

<insert id="insert" parameterType="com.bookat.dto.PaymentDto"
        useGeneratedKeys="true" keyProperty="paymentId" keyColumn="payment_id">
  INSERT INTO PAYMENT(
      payment_id, order_id, total_price, payment_price, payment_method,
      payment_status, payment_date, payment_info, merchant_uid
  )
  VALUES(
      SEQ_PAYMENT.NEXTVAL,
      #{orderId,jdbcType=NUMERIC},         <!-- null 가능-->
      #{totalPrice},                       <!-- NOT NULL -->
      #{paymentPrice},                     <!-- NOT NULL -->
      #{paymentMethod},                    <!-- NOT NULL -->
      #{paymentStatus},                    <!-- NOT NULL -->
      SYSDATE,
      #{paymentInfo,jdbcType=VARCHAR},     <!-- null 가능-->
      #{merchantUid}                       <!-- UNIQUE/NOT NULL로 사용 -->
  )
</insert>

  <update id="markPaidByMerchantUid" parameterType="map">
    UPDATE PAYMENT SET
      payment_status = 1,
      imp_uid = #{impUid},
      pg_tid = #{pgTid},
      receipt_url = #{receiptUrl}
    WHERE merchant_uid = #{merchantUid}
  </update>

  <update id="markFailedByMerchantUid" parameterType="map">
    UPDATE PAYMENT SET
      payment_status = -1,
      fail_reason = #{failReason}
    WHERE merchant_uid = #{merchantUid}
  </update>
  
  <update id="markCancelledByMerchantUid" parameterType="string">
  UPDATE PAYMENT SET payment_status = 2 WHERE merchant_uid = #{merchantUid}
</update>

<update id="markPartCancelledByMerchantUid" parameterType="map">
  UPDATE PAYMENT
  SET payment_status = 3,
      -- (선택) cancel_amount 누적/기록을 쓴다면 여기서 갱신
      receipt_url = NVL(receipt_url, #{receiptUrl})
  WHERE merchant_uid = #{merchantUid}
</update>
  
</mapper>