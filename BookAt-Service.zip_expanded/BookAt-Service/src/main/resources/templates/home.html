<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>홈</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script type="text/javascript">
    
	$(document).ready(async function() {
	    const accessTokenKey = "accessToken";

	    function isTokenExpired(token) {
	        if (!token) return true;
	        try {
	            const payload = JSON.parse(atob(token.split(".")[1]));
	            const exp = payload.exp * 1000;
	            return Date.now() >= exp;
	        } catch(e) {
	            return true; // 파싱 실패하면 만료로 간주
	        }
	    }

		async function handleLogout() {
	        const token = localStorage.getItem(accessTokenKey);
			
			console.log("handleLogout 진입");
			console.log("로그아웃 시점 엑세스 : " + token);

	        // 백엔드 로그아웃 요청
	        try {
	            await $.ajax({
	                url: "/api/user/logout",
	                type: "POST",
	                headers: { "Authorization": "Bearer " + (token || "") },
	                xhrFields: { withCredentials: true }
	            });
	        } catch(err) {
	            console.error("서버 로그아웃 실패", err);
	        }

	        // 프론트 토큰 삭제 & UI 갱신
	        localStorage.removeItem(accessTokenKey);
	        updateAuthUI(null);
	    }
		
	    async function refreshAccessTokenIfNeeded() {
	        let token = localStorage.getItem(accessTokenKey);
	        console.log("현재 access token:", token);

	        if (!token || isTokenExpired(token)) {
	            try {
	                const res = await $.ajax({
	                    url: "/api/user/refresh",
	                    type: "POST",
	                    xhrFields: { withCredentials: true } // HttpOnly 쿠키 전송
	                });
	                console.log("new access token:", res.accessToken);
	                if (res.accessToken) {
	                    localStorage.setItem(accessTokenKey, res.accessToken);
	                    token = res.accessToken;
	                }
	            } catch(err) {
	                console.log("자동 로그인 실패, access token 발급 불가");
					
					await handleLogout();
	                token = null;
	            }
	        }

	        return token;
	    }

	    const token = await refreshAccessTokenIfNeeded();
	    updateAuthUI(token);

	    function updateAuthUI(token) {
	        if(token){
	            $("#loginBtn").hide();
	            $("#logoutBtn").show();
	        } else {
	            $("#loginBtn").show();
	            $("#logoutBtn").hide();
	        }
	    }

	    $("#loginBtn").click(() => window.location.href = "/api/user/login");

	    $("#logoutBtn").click(async function(event) {
	        event.preventDefault();

	        await handleLogout();
	    });
	});
	
</script>
</head>
<body>
    <h1>홈 화면</h1>

    <div id="container">
        <button id="loginBtn">로그인</button>
        <button id="logoutBtn" style="display:none;">로그아웃</button>
    </div>

</body>
</html>
