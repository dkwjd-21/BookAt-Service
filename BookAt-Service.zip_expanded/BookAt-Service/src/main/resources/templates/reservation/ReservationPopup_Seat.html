<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Document</title>
	
	<!-- 지나 추가 -->
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:src="@{/js/utils/axiosIntercepter.js}"></script>
    <script th:src="@{/js/utils/userAuth.js}"></script>
    <script th:src="@{/js/payment.js}"></script>
    
	<link rel="stylesheet" th:href="@{/css/ReservationPopup_Seat.css}" />
	<link rel="stylesheet" th:href="@{/css/captcha.css}" />
	<script th:src="@{/js/utils/captcha.js}"></script>
	<script th:src="@{/js/ReservationPopup_Seat.js}"></script>
</head>

<body>
	<div class="popup-container">
		<header>
			<img th:src="@{/images/BookAt-Logo.png}" alt="BookAt Logo" class="logo">
		</header>

		<div class="body-wrapper">

			<div class="left-column">
				<nav class="progress-steps">
					<ol>
						<li class="active">날짜/회차 선택</li>
						<li data-step="2" th:text="${event.ticketType == 'SEAT_TYPE'} ? '좌석 선택' : '등급 선택'"></li>
						<li>정보 입력</li>
						<li>결제</li>
					</ol>
				</nav>

				<main class="content-wrapper">
					<section class="firstSection">
						<input type="hidden" id="eventDate" th:value="${#dates.format(event.eventDate, 'yyyy-MM-dd')}">
						<div class="calendar-container">
							<div id="Date">
								<b onclick="defaultCalendar()" style="cursor: pointer;">2025년 5월</b>
								<span class="changeMon" style="display: none;">
									<button onclick="prevCalendar()"> ◀ </button>
									<button onclick="nextCalendar()"> ▶ </button>
								</span>
							</div>
							<div id="Calender">
								<table>
									<thead>
										<tr>
											<th style="color: red;">일</th>
											<th>월</th>
											<th>화</th>
											<th>수</th>
											<th>목</th>
											<th>금</th>
											<th style="color: blue;">토</th>
										</tr>
									</thead>
									<tbody id="calenderTbody">
									</tbody>
								</table>
							</div>
						</div>
						<div class="select-container">
							<div class="select-day">
								날짜 선택
							</div>
							<div class="option-day" th:text="${#dates.format(event.eventDate, 'M월 d일')}">9월 17일</div>
							<div class="select-part">
								회차 선택
							</div>
							<div class="part-options-container">
								<div class="option-part" data-session-id="1">9월 17일 10:00 1회차</div>
								<div class="option-part" data-session-id="2">9월 17일 14:00 2회차</div>
								<div class="option-part" data-session-id="3">9월 17일 19:00 3회차</div>
							</div>
						</div>
					</section>
				</main>
			</div>

			<aside class="summary-content">
				<div class="event-poster">
					<img class="posterImg" th:src="@{${event.eventImage}}" alt="이벤트포스터">
					<h2 th:text="${event.eventName}">이벤트명</h2>
					<p th:text="${#dates.format(event.eventDate, 'yyyy년 M월 d일')}">이벤트날짜</p>
					<p>선택회차</p>
				</div>
				<button class="next-button">다음 단계</button>
				
				<!-- 지나 추가 -->
				<!-- 추후 amount는 화면에서 계산된 최종 합계로 가져와야함 -->
		        <button id="eventPayBtn"
		                th:attr="data-event-id=${event.eventId},
                        data-title=${event.eventName},
                        data-amount=${event.eventPrice}"  
                        class="next-button">결제하기
                </button>
                
			</aside>

		</div>

	</div>

	<!-- 캡챠 인증 모달 -->
   <div id="captchaModal" class="modal-overlay" style="display: none;">
		<div class="captcha-form">
			<label class="captcha-label">매크로 방지</label>
			<div class="captcha-body">
				<img id="captchaImg" title="캡챠이미지" alt="캡챠이미지" th:src="@{/api/captcha/image}">
				<button type="button" class="captcha-btn" onclick="refreshImage();">새로고침</button>
				<button type="button" class="captcha-btn" onclick="playAudio();">음성듣기</button>
				<div id="ccaudio" style="display: none;"></div>
			</div>
			<p class="captcha-message">인증번호를 올바르게 입력해주세요.</p>
			<div class="captcha-input-group">
				<input id="captcha-answer" type="text" placeholder="보이는 문자를 입력하세요">
				<button id="captcha-submit" type="button" onclick="verifyCaptcha()">확인</button>
			</div>
		</div>
	</div>
</body>

<!-- 지나 추가 -->
<script>
  document.getElementById('eventPayBtn')?.addEventListener('click', async (e) => {
    const btn = e.currentTarget;
    try {
      await window.PaymentStart.event({
        eventId: Number(btn.dataset.eventId),
        amount: Number(btn.dataset.amount),
        title:  btn.dataset.title,
        method: "CARD"
      });
    } catch (err) {
      console.error(err); alert(err.message || "결제 준비 실패");
    }
  });
</script>

</html>