<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>결제 완료</title>

  <link rel="stylesheet" th:href="@{/css/header.css}" />
  <link rel="stylesheet" th:href="@{/css/footer.css}" />
  <link rel="stylesheet" th:href="@{/css/orderlist.css}" />
  <link rel="stylesheet" th:href="@{/css/payment.css}" />
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script th:src="@{/js/utils/axiosIntercepter.js}"></script>
  <script th:src="@{/js/utils/logout.js}"></script>
  <script th:src="@{/js/utils/userAuth.js}"></script>
  <script th:src="@{/js/utils/header.js}"></script>
  
</head>

<div th:replace="~{fragments/header :: main-header}"></div>

<body class="success-body">  
  <div class="container order-complete">

    <!-- 상단 위치/상태 -->
    <div class="panel panel-crumb">
      <div class="crumb-left">
        <span class="crumb-label">주문/결제</span>
        <span class="crumb-sep">›</span>
        <span class="crumb-current">결제 완료</span>
      </div>
      <span class="status-badge">PAID</span>
    </div>

    <!-- 완료 안내 -->
    <div class="panel panel-success combined">
      <div class="success-head">
        <!-- 체크 아이콘은 심플하게 텍스트로 대체하거나, 아이콘 파일 사용 시 <img>로 교체 -->
        <svg class="icon-check" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 16.2l-3.5-3.5L4 14.2 9 19l11-11-1.5-1.5z"></path>
        </svg>
        <div>
          <p class="title">결제가 완료되었습니다</p>
          <!-- 주문 타이틀 표시 -->
          <p class="meta" th:if="${title != null and #strings.isNotEmpty(title)}">
            주문명: <strong th:text="${title}">도서 결제</strong>
          </p>
          <p class="meta">
            주문일시:
            <span th:text="${#temporals.format(orderDate, 'yyyy-MM-dd HH:mm')}">2025-10-13 10:00</span>
            · 결제수단: <span th:text="${method}">CARD</span>
            · 결제번호: <span th:text="${merchantUid}">PAY-...</span>
            <span th:if="${pgTid != null}"> · PG TID: <span th:text="${pgTid}">tid</span></span>
            <span th:if="${receiptUrl != null}">
              · 영수증: <a th:href="${receiptUrl}" target="_blank" rel="noopener">열기</a>
            </span>
          </p>
        </div>
      </div>
    </div>

    <!-- 주문 상품 -->
    <div class="panel">
      <div class="panel-head">
        <h2 class="section-title">주문 상품</h2>
        <span class="muted" th:if="${#lists.isEmpty(items)}">주문 상품 정보가 없습니다.</span>
      </div>
      <ul class="item-list" th:if="${!#lists.isEmpty(items)}">
        <li class="item" th:each="it : ${items}">
          <div class="thumb">
            <img th:src="${it.coverImage}" alt="cover" />
          </div>
          <div>
            <a class="item-title" th:text="${it.title}" href="javascript:void(0)">도서 제목</a>
            <div class="item-sub" th:text="${it.author}">저자</div>
            <div class="item-sub">
              수량: <span th:text="${it.quantity}">1</span> ·
              단가: <span th:text="${#numbers.formatInteger(it.price, 3, 'COMMA')}">0</span>원
            </div>
          </div>
        </li>
      </ul>
    </div>

    <!-- 결제 금액 요약 -->
    <div class="panel">
      <div class="panel-head">
        <h2 class="section-title">결제 금액</h2>
      </div>
      <div class="summary">
        <div class="summary-row">
          <div>상품 합계</div>
          <div class="amt"><strong th:text="${#numbers.formatInteger(productTotal, 3, 'COMMA')}">0</strong><i>원</i></div>
        </div>
        <div class="summary-row">
          <div>배송비</div>
          <div class="amt"><strong th:text="${#numbers.formatInteger(shippingFee, 3, 'COMMA')}">0</strong><i>원</i></div>
        </div>
        <div class="summary-row" th:if="${usedPoint != null and usedPoint > 0}">
          <div>사용 포인트</div>
          <div class="amt">-<strong th:text="${#numbers.formatInteger(usedPoint, 3, 'COMMA')}">0</strong><i>P</i></div>
        </div>

        <div class="summary-divider"></div>

        <div class="summary-row total">
          <div>총 결제금액</div>
          <div class="amt"><strong th:text="${#numbers.formatInteger(amount, 3, 'COMMA')}">0</strong><i>원</i></div>
        </div>

        <p class="summary-sub" th:if="${earnPoint != null and earnPoint > 0}">
          적립 예정 포인트: <span class="point" th:text="${#numbers.formatInteger(earnPoint, 3, 'COMMA')}">0</span>P
        </p>

        <div class="delivery-box">
          <span class="label">예상 배송일</span>
          <span class="date">10월 20일(월) 도착 예정</span>
        </div>
      </div>
    </div>

    <!-- 하단 액션 -->
    <div class="action-row">
      <a th:href="@{/myPage}" class="btn btn--primary">마이페이지</a>
      <a th:href="@{/}" class="btn">쇼핑 계속하기</a>
    </div>
  </div>
</body>

<div th:replace="~{fragments/footer :: main-footer}"></div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const m = qs.get('m'), i = qs.get('i'), t = qs.get('t');
  if (!m) { alert("잘못된 접근"); location.href="/"; return; }

  const fmt = (n)=> (n==null?"0":String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

  axiosInstance.get("/payment/success/api", { params: { m, i, t }})
    .then(({data}) => {
      if (data.status !== "success") throw new Error(data.message||"로드 실패");

      // 상단 타이틀/메타 채우기
      const titleEl = document.querySelector(".panel-success .title");
      if (titleEl && data.title) titleEl.textContent = "결제가 완료되었습니다";

      const metaWrap = document.querySelector(".panel-success .meta");
      if (metaWrap) {
        // 주문명 표시
        const strong = metaWrap.querySelector("strong");
        if (strong) strong.textContent = data.title || strong.textContent;

        // 결제수단/번호/PG/영수증
        metaWrap.innerHTML = `
          주문명: <strong>${data.title || '도서 결제'}</strong>
          <br/>
          주문일시: ${data.orderDate ? data.orderDate.replace('T',' ').slice(0,16) : ''}
          · 결제수단: ${data.method || ''}
          · 결제번호: ${data.merchantUid || ''}
          ${data.pgTid ? ` · PG TID: ${data.pgTid}` : ''}
          ${data.receiptUrl ? ` · 영수증: <a href="${data.receiptUrl}" target="_blank" rel="noopener">열기</a>` : ''}
        `;
      }

      // 주문 상품 리스트 렌더링
      const emptyMsg = document.querySelector(".panel .panel-head .muted");
      const list = document.querySelector(".panel .item-list");
      if (Array.isArray(data.items) && data.items.length > 0 && list) {
        if (emptyMsg) emptyMsg.style.display = "none";
        list.innerHTML = "";
        data.items.forEach(it => {
          const li = document.createElement("li");
          li.className = "item";
          li.innerHTML = `
            <div class="thumb"><img src="${it.coverImage||''}" alt="cover" /></div>
            <div>
              <a class="item-title">${it.title||''}</a>
              <div class="item-sub">${it.author||''}</div>
              <div class="item-sub">
                수량: <span>${it.quantity ?? 1}</span> ·
                단가: <span>${fmt(it.price)}</span>원
              </div>
            </div>
          `;
          list.appendChild(li);
        });
      }

      // 금액 요약
      const productTotalEl = document.querySelector(".summary .summary-row:nth-child(1) strong");
      const shippingEl     = document.querySelector(".summary .summary-row:nth-child(2) strong");
      const totalEl        = document.querySelector(".summary .total strong");

      if (productTotalEl) productTotalEl.textContent = fmt(
        (data.items || []).reduce((sum, it) => sum + (it.price || 0) * (it.quantity || 1), 0)
      );
      if (shippingEl) shippingEl.textContent = fmt(0); // 정책에 따라 필요시 값 교체
      if (totalEl) totalEl.textContent = fmt(data.amount);
    })
    .catch(err => {
      console.error(err);
      alert("결과를 불러올 수 없습니다.");
      location.href = "/";
    });
})();
</script>

</html>