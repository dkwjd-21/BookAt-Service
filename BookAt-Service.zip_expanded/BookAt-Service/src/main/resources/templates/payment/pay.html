<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head><meta charset="UTF-8"><title>결제</title></head>
<body>
  <h2>결제 테스트</h2>
  <p>금액: <span th:text="${amount}"></span>원</p>

  <form id="completeForm" th:action="@{/payment/complete}" method="post" style="display:none;">
    <input type="hidden" name="imp_uid" id="imp_uid">
    <input type="hidden" name="merchant_uid" th:value="${merchantUid}">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
  </form>

  <button id="payBtn">결제하기</button>

  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  <script>
    // 가맹점 식별코드
    IMP.init(/*[['imp55525217']]*/ 'imp55525217'); 

    document.getElementById("payBtn").onclick = function(){
      const merchantUid = /*[[${merchantUid}]]*/ '';
      const amount = /*[[${amount}]]*/ 0;

      IMP.request_pay({
        pg: "html5_inicis", // TODO: 팀 설정값
        pay_method: "card",
        name: "북캣 테스트 결제",
        merchant_uid: merchantUid,
        amount: amount
      }, function (rsp) {
        if (rsp.success) {
          document.getElementById("imp_uid").value = rsp.imp_uid;
          document.getElementById("completeForm").submit();
        } else {
          alert("결제 실패: " + rsp.error_msg);
          // 실패 페이지로 유도하고 싶다면 서버에 실패 기록을 남기고 이동
        }
      });
    };
  </script>
</body>
</html>