<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>아이디 찾기</title>
<link rel="stylesheet" th:href="@{/css/logindefault.css}">
<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
<script th:inline="javascript">
	async function verification() {

	const PORTONE_STORE_ID = /*[[${portoneStoreId}]]*/ "default-store-id";
	const PORTONE_CHANNEL_KEY = /*[[${portoneChannelKey}]]*/ "default-channel-key";

	  try {
	    // 1. 포트원 본인인증을 호출 & 사용자가 완료할 때까지 기다림
	    const portoneResponse = await PortOne.requestIdentityVerification({
	      storeId: PORTONE_STORE_ID,
	      identityVerificationId: `identity-verification-${crypto.randomUUID()}`,
	      channelKey: PORTONE_CHANNEL_KEY,
	    });
	
	    // 2. 사용자가 창을 닫거나 인증에 실패한 경우 에러를 발생시켜 중단
	    if (portoneResponse.code != null) {
	      throw new Error(portoneResponse.message);
	    }
	
	    // 3. 백엔드에 identityVerificationId를 보내 최종 검증을 요청
	    const backendResponse = await fetch("/user/verify", {
	      method: "POST",
	      headers: { "Content-Type": "application/json" },
	      body: JSON.stringify({
	        identityVerificationId: portoneResponse.identityVerificationId,
	      }),
	    });
	
	    if (!backendResponse.ok) {
	      throw new Error("서버에서 인증 정보를 확인하는 데 실패했습니다.");
	    }
		
		const userInfo = await backendResponse.json();
		
		if(userInfo.status === "success") {
			// 아이디 찾기 성공
			document.getElementById("find-id-info").textContent = "{ " + userInfo.userId + " }";
			document.getElementById("find-id").style.display = "block";
			document.getElementById("verify-btn").style.display = "none";
			document.getElementById("find-id-result-err").style.display = "none";
		} else if(userInfo.status === "userNotFound") {
			// 회원 정보 없음
			document.getElementById("find-id-result-err").textContent = userInfo.message;
			document.getElementById("find-id-result-err").style.display = "block";
			document.getElementById("find-id").style.display = "block";
			document.getElementById("find-id-result").style.display = "none";
			document.getElementById("verify-btn").style.display = "none";
		} else {
			// 백엔드로부터 받은 상태가 'failed'면 에러를 발생시켜 중단
			throw new Error(userInfo.message || "서버에서 인증 처리에 실패했습니다.");
		}
		
	  } catch (error) {
	    // 모든 에러(인증 실패, 통신 오류 등)를 여기서 한 번에 처리
	    alert(error.message);
	  }
	}
</script>
</head>
<body>
	<div id="container">
		<h1>아이디 찾기</h1>
		
		<div class="login-container">
			<div id="verify-btn" class="verify-btn">
				<button onclick="verification()">간편인증</button>
			</div>
			
			<div id="find-id" class="find-id" style="display:none">
				<p id="find-id-result" class="find-id-result">회원님의 아이디는 <span id="find-id-info"></span>입니다.</p>
				<p id="find-id-result-err" class="find-id-result" style="display:none"></p>
			</div>
			
			<div class="links">
				<a href="/user/login">로그인 페이지로 가기</a><span>|</span>
				<a href="/user/findPw">비밀번호 찾기</a>
			</div>
		</div>
	</div>
</body>
</html>
