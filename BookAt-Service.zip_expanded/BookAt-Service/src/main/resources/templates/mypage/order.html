<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>주문하기 - BookAt</title>
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/order.css}" />
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:src="@{/js/utils/axiosIntercepter.js}"></script>
    <script th:src="@{/js/utils/logout.js}"></script>
    <script th:src="@{/js/utils/userAuth.js}"></script>
    <script th:src="@{/js/utils/header.js}"></script>
    <script th:src="@{/js/order.js}"></script>
    <script th:src="@{/js/payment.js}"></script>
  </head>
  <body>
    <!-- 아래 1줄 지나 추가 -->
    <input type="hidden" id="orderId" th:value="${orderId}">
    
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="order-container">
      <div class="order-layout">
        <!-- 왼쪽 컬럼: 주문 상세 정보 -->
        <div class="order-details">
          <!-- 배송지 정보 섹션 -->
          <div class="order-section">
            <h1>주문 / 결제</h1>
            <hr class="title-divider" />
            <div class="section-header">
              <h2>배송지 정보</h2>
              <button type="button" class="btn-change" onclick="openAddressModal()">변경</button>
            </div>

            <div class="delivery-info">
              <div class="delivery-main">
                <div class="delivery-item">
                  <span class="delivery-label">이름</span>
                  <div class="delivery-content">
                    <span id="display-name" th:text="${address != null ? address.recipientName : user.userName}" th:if="${address != null or user.userName != null}">수령인</span>
                    <span id="display-name" th:if="${address == null and user.userName == null}" style="color: #999">배송지를 입력해주세요</span>
                  </div>
                </div>
                <div class="delivery-item">
                  <span class="delivery-label">전화번호</span>
                  <div class="delivery-content">
                    <span class="phone-number" id="display-phone" th:text="${address != null ? address.recipientPhone : user.phone}" th:if="${address != null or user.phone != null}">연락처</span>
                    <span id="display-phone" th:if="${address == null and user.phone == null}" style="color: #999">배송지를 입력해주세요</span>
                  </div>
                </div>
                <div class="delivery-item">
                  <span class="delivery-label">주소</span>
                  <div class="delivery-content">
                    <span id="display-address" th:text="${address != null ? address.addr : '배송지를 입력해주세요'}" th:if="${address != null}">주소</span>
                    <span id="display-address" th:if="${address == null}" style="color: #999">배송지를 입력해주세요</span>
                  </div>
                </div>
                <div class="delivery-item">
                  <span class="delivery-label">배송 요청 사항</span>
                  <div class="delivery-content">
                    <input type="text" placeholder="배송 요청사항을 입력해주세요" />
                  </div>
                </div>
                <div class="delivery-item">
                  <span class="delivery-label">공동현관문 출입방법</span>
                  <div class="delivery-content">
                    <input type="text" placeholder="공동현관문 출입방법을 입력해주세요" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 주문 상품 섹션 -->
          <div class="order-section">
            <h2>주문 상품</h2>
            <div id="orderItems" class="order-items">
              <!-- 주문 상품들이 여기에 동적으로 추가 -->
            </div>
            <div class="order-info">
              <div class="info-item">
                <span>결제 예정 금액 안내</span>
                <span id="total">0원</span>
              </div>
              <div class="info-item">
                <span>배송 예정일 안내</span>
                <span>2-3일 내 배송 예정</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 오른쪽 컬럼: 주문 요약 -->
        <div class="order-summary-section">
          <div class="summary-box">
            <h3>주문 요약</h3>
            <div class="summary-list">
              <div class="summary-item">
                <span>상품 금액 합계</span>
                <span id="subtotal">0원</span>
              </div>
              <div class="summary-item">
                <span>배송비</span>
                <span id="shippingFee">무료</span>
              </div>
              <div class="summary-item total">
                <span>결제 예정 금액</span>
                <span id="totalAmount">0원</span>
              </div>
              <div class="summary-item">
                <span>적립 예정 포인트</span>
                <span id="points">0P</span>
              </div>
            </div>
            <div th:replace="~{fragments/payFragment :: payFragment}"></div>
          </div>
        </div>
       
      </div>
    </div>

    <!-- 주소 변경 모달 -->
    <div id="addressModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>배송지 변경</h3>
          <span class="close" onclick="closeAddressModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="modal-name">수령인</label>
            <input type="text" id="modal-name" placeholder="수령인 이름을 입력하세요" />
          </div>
          <div class="form-group">
            <label for="modal-phone">전화번호</label>
            <input type="text" id="modal-phone" placeholder="전화번호를 입력하세요" />
          </div>
          <div class="form-group">
            <label for="modal-postcode">우편번호</label>
            <div class="postcode-group">
              <input type="text" id="modal-postcode" placeholder="우편번호" readonly />
              <button type="button" class="btn-postcode" onclick="execDaumPostcode()">우편번호 찾기</button>
            </div>
          </div>
          <div class="form-group">
            <label for="modal-roadAddress">도로명 주소</label>
            <input type="text" id="modal-roadAddress" placeholder="도로명주소" readonly />
          </div>
          <div class="form-group">
            <label for="modal-detailAddress">상세 주소</label>
            <input type="text" id="modal-detailAddress" placeholder="상세주소를 입력하세요" />
          </div>
          <div class="form-group">
            <label for="modal-extraAddress">참고 항목</label>
            <input type="text" id="modal-extraAddress" placeholder="참고항목" readonly />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeAddressModal()">취소</button>
          <button type="button" class="btn-primary" onclick="saveAddress()">저장</button>
        </div>
      </div>
    </div>

    <!-- 다음 주소 API -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <!-- Thymeleaf 데이터를 JavaScript로 전달 -->
    <script th:inline="javascript">
      // 서버에서 전달받은 도서 정보를 JavaScript에서 사용할 수 있도록 설정
      window.bookData = {
        bookId: /*[[${book?.bookId}]]*/ null,
        title: /*[[${book?.title}]]*/ null,
        author: /*[[${book?.author}]]*/ null,
        price: /*[[${book?.price}]]*/ 0,
        imageUrl: /*[[${book?.imageUrl}]]*/ null,
        coverImage: /*[[${book?.imageUrl}]]*/ null, // imageUrl을 coverImage로도 사용
      };
      window.quantity = /*[[${quantity}]]*/ 1;
      window.isDirectOrder = /*[[${isDirectOrder}]]*/ false;
    </script>

    <div th:replace="~{fragments/footer :: main-footer}"></div>
  </body>
</html>
