<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <head>
    <meta charset="UTF-8" />
    <title th:text="'BookAt - '+${book.title}">BookAt</title>

    <!-- 기존 공통 CSS -->
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/main_book.css}" />
    <link rel="stylesheet" th:href="@{/css/event_mainpage.css}" />
    <!-- 상세 전용 CSS -->
    <link rel="stylesheet" th:href="@{/css/detail_book.css}" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:src="@{/js/utils/axiosIntercepter.js}"></script>
    <script th:src="@{/js/utils/logout.js}"></script>
    <script th:src="@{/js/utils/userAuth.js}"></script>
    <script th:src="@{/js/utils/header.js}"></script>
    <script th:src="@{/js/BookDetail.js}"></script>
  </head>

  <body style="background: #f7f8fa">
    <div th:replace="~{fragments/header :: main-header}"></div>

    <!-- 상단 카테고리 패널 -->
    <div class="panel panel-crumb">
      <span class="crumb-label">도서 카테고리</span>
      <a
        class="crumb-cat"
        th:href="@{/books(category=${book.category})}"
        th:text="${book.category == 'SELF-HELP' ? '자기계발' :
               book.category == 'FICTION' ? '소설' :
               book.category == 'POETRY' ? '시' :
               book.category == 'ESSAY' ? '에세이' :
               book.category == 'HUMANITY' ? '인문' :
               book.category == 'MAGAZINE' ? '잡지' :
               book.category == 'KIDS' ? '아동도서' :
               book.category == 'HOBBY' ? '취미' : '전체 도서'}"
      >
        카테고리
      </a>
    </div>

    <!-- 도서 상세 패널 -->
    <section class="panel" style="margin-top: 16px">
      <div class="detail-grid">
        <!-- 표지 -->
        <img class="detail-thumb" th:src="${book.imageUrl != null ? book.imageUrl : 'https://placehold.co/340x440?text=Book'}" th:alt="${book.title}" />

        <!-- 정보 -->
        <div>
          <h1 class="detail-title" th:text="${book.title}">책 제목</h1>

          <div class="detail-meta">
            <span>저자</span>&nbsp;&nbsp;|&nbsp;&nbsp;<span th:text="${book.author}">작가명</span>
            <br />
            <span>출판사</span>&nbsp;&nbsp;|&nbsp;&nbsp;<span th:text="${book.publisher}">출판사</span>
            <br />
            <span>출간일</span>&nbsp;&nbsp;|&nbsp;&nbsp;<span th:text="${book.pubdate != null ? #temporals.format(book.pubdate, 'yyyy년 MM월 dd일') : '-'}">2025년 09월 01일</span>
            <br />
            
            <div class="detail-rating">
              <span>리뷰</span>&nbsp;|&nbsp;

              <!-- 평균 별점 -->
              <span class="stars">
                <span th:each="i : ${#numbers.sequence(1,5)}"
                      th:text="${i <= avgRatingRounded} ? '★' : '☆'"
                      th:classappend="${i <= avgRatingRounded} ? 'on' : ''">★</span>
              </span>

              <!-- 평균값 숫자 -->
              <span class="meta"
                    th:text="${#numbers.formatDecimal(avgRating, 1, 'POINT', 1, 'POINT')} + ' / 5.0'">0.0 / 5.0</span>

              <!-- 총 리뷰 개수 -->
              <span class="meta" th:text="'(' + ${reviewCount} + ')'">(0)</span>
            </div>
            
            <br />
          </div>

          <!-- 리뷰와 가격 사이 연한 구분선 -->
          <div class="soft-divider"></div>

          <!-- 가격 + 배송 문구 -->
          <div class="detail-price-row"><span class="price-number" th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')}"></span>원 &nbsp;&nbsp; <span class="ship-note">기본배송비 3,000원 / 15,000원 이상 무료</span></div>

          <!-- 수량 + 버튼들 -->
          <div class="detail-qty-row">
            <label for="qty">수량</label>
            <input
              class="detail-qty"
              id="qty"
              type="number"
              min="1"
              max="99"
              value="1"
              oninput="
                let qtyValue = parseInt(this.value);
                if (isNaN(qtyValue) || qtyValue < 1) {
                  this.value = 1;
                } else if (qtyValue > 99) {
                  this.value = 99;
                }
                document.getElementById('giftQty').value = this.value;
                document.getElementById('cartQty').value = this.value;
                document.getElementById('orderQty').value = this.value;"
            />
          </div>

          <!-- 버튼 (아래 줄에) -->
          <div class="detail-btn-row">
            <!-- 위시리스트 -->
            <form th:action="@{|/books/${book.bookId}/wishlist|}" method="post">
              <button type="submit" class="btn-heart" th:classappend="${liked} ? ' is-liked' : ''">
                <span class="icon" th:text="${liked} ? '♥' : '♡'">♡</span>
                <span></span>
              </button>
            </form>

            <!-- 선물하기 -->
            <form th:action="@{|/books/${book.bookId}/gift|}" method="post">
              <input type="hidden" id="giftQty" name="qty" value="1" />
              <button class="btn" type="submit">선물하기</button>
            </form>

            <!-- 장바구니 -->
            <button class="btn" type="button" id="addToCartBtn">장바구니 담기</button>

            <!-- 바로구매 -->
            <button class="btn btn--primary" type="button" id="directOrderBtn">바로구매</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 1) '도서 관련 이벤트' 패널 -->
    <section class="panel" style="margin-top: 16px">
      <h3 class="section-title" style="margin: 0 0 12px 0">관련 이벤트</h3>

      <div th:if="${events == null or #lists.isEmpty(events)}" style="color: #6b7280">진행 중인 이벤트가 없습니다.</div>

      <div th:if="${events != null and !#lists.isEmpty(events)}" class="event-list">
        <!-- 상세페이지 merge 후 수정 -->
        <a th:each="event : ${events}" th:href="@{/events/detail(event_id=${event.eventId})}" class="event-card">
          <img th:src="${event.eventImage}" alt="event Cover" class="event-cover" />
          <p class="meta" th:text="${#strings.substring(event.address, 0, 2)}"></p>
          <p th:text="${event.eventName}" class="event-title">이벤트 이름</p>
        </a>
      </div>
    </section>

    <!-- 2) 도서 소개 패널 -->
    <section class="panel" style="margin-top: 16px">
      <h3 class="section-title" style="margin: 0 0 12px 0">도서 소개</h3>
      <div style="white-space: pre-line; color: #374151" th:text="${book.description}">설명</div>
    </section>

    <!-- 3) 전체 리뷰 패널 -->
    <section class="panel" style="margin-top: 16px">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px">
        <h3 class="section-title" style="margin: 0">전체 리뷰 (<span th:text="${reviewCount}">0</span>)</h3>
        <button type="button" class="review-write-btn" id="openReviewModalBtn">리뷰 작성</button>
      </div>
      <div class="soft-divider"></div>

      <!-- 리뷰 없을 때 -->
      <div th:if="${#lists.isEmpty(reviews)}" style="color: #6b7280">작성된 리뷰가 없습니다.</div>

      <!-- 리뷰 리스트 -->
      <div th:each="rv : ${reviews}" class="review-item-container" style="padding: 30px 0; border-bottom: 2px solid #eee; position: relative" th:attr="data-review-id=${rv.reviewId}, data-author-id=${rv.userId}, data-title=${rv.title}, data-content=${rv.content}, data-rating=${rv.rating}">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px">
          <!-- 별점 표시: 가득★ 와 빈☆를 5개 기준으로 -->
          <span>
            <span class="stars">
              <span th:each="i : ${#numbers.sequence(1,5)}" th:text="${i <= rv.rating} ? '★' : '☆'" th:classappend="${i <= rv.rating} ? 'on' : ''">★</span>
            </span>
          </span>
          <span class="meta review-author-id" th:text="${rv.userId}">user_id</span>&nbsp;&nbsp;|&nbsp;&nbsp;
          <span class="meta" th:text="${#temporals.format(rv.createdAt, 'yyyy.MM.dd')}">2025.09.01</span>
        </div>

        <!-- 리뷰 제목 -->
        <div style="font-weight: 600; font-size: 16px; color: #111827; margin-top: 12px; margin-left: 90px; word-wrap: break-word; overflow-wrap: break-word; max-width: calc(100% - 120px)" th:text="${rv.title}">리뷰 제목</div>

        <!-- 리뷰 내용 -->
        <div style="white-space: pre-line; color: #374151; margin-top: 8px; margin-left: 90px; word-wrap: break-word; overflow-wrap: break-word; max-width: calc(100% - 120px)" th:text="${rv.content}">리뷰 내용</div>

        <!-- 수정/삭제 버튼 (JavaScript로 동적으로 표시) -->
        <div class="review-actions" style="position: absolute; top: 30px; right: 0; display: none; gap: 8px">
          <button type="button" class="review-action-btn edit-btn">수정</button>
          <button type="button" class="review-action-btn delete-btn">삭제</button>
        </div>
      </div>
    </section>

    <!-- 리뷰 작성 모달 -->
    <div id="reviewModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>리뷰 작성</h2>

        <form id="reviewForm">
          <div class="form-group">
            <label>별점</label>
            <div class="stars-input" id="starsInput">
              <span class="star" data-value="1">★</span>
              <span class="star" data-value="2">★</span>
              <span class="star" data-value="3">★</span>
              <span class="star" data-value="4">★</span>
              <span class="star" data-value="5">★</span>
            </div>
            <input type="hidden" id="rating" name="rating" value="0" required />
          </div>

          <div class="form-group">
            <label for="reviewTitle">리뷰 제목</label>
            <input type="text" id="reviewTitle" name="title" placeholder="리뷰 제목을 입력해주세요." maxlength="50" required />
            <div class="char-count"><span id="titleCharCount">0</span>/50자</div>
          </div>

          <div class="form-group">
            <label for="reviewContent">리뷰 내용</label>
            <textarea id="reviewContent" name="content" rows="6" placeholder="리뷰 내용을 입력해주세요." maxlength="500" style="resize: vertical; word-wrap: break-word" required></textarea>
            <div class="char-count"><span id="contentCharCount">0</span>/500자</div>
          </div>

          <button type="submit" class="submit-btn">등록하기</button>
        </form>
      </div>
    </div>

    <!-- 리뷰 수정 모달 -->
    <div id="editReviewModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>리뷰 수정</h2>

        <form id="editReviewForm">
          <input type="hidden" id="editReviewId" />

          <div class="form-group">
            <label>별점</label>
            <div class="stars-input" id="editStarsInput">
              <span class="star" data-value="1">★</span>
              <span class="star" data-value="2">★</span>
              <span class="star" data-value="3">★</span>
              <span class="star" data-value="4">★</span>
              <span class="star" data-value="5">★</span>
            </div>
            <input type="hidden" id="editRating" name="rating" value="0" required />
          </div>

          <div class="form-group">
            <label for="editReviewTitle">리뷰 제목</label>
            <input type="text" id="editReviewTitle" name="title" placeholder="리뷰 제목을 입력해주세요." maxlength="50" required />
            <div class="char-count"><span id="editTitleCharCount">0</span>/50자</div>
          </div>

          <div class="form-group">
            <label for="editReviewContent">리뷰 내용</label>
            <textarea id="editReviewContent" name="content" rows="6" placeholder="리뷰 내용을 입력해주세요." maxlength="500" style="resize: vertical; word-wrap: break-word" required></textarea>
            <div class="char-count"><span id="editContentCharCount">0</span>/500자</div>
          </div>

          <button type="submit" class="submit-btn">수정하기</button>
        </form>
      </div>
    </div>

    <!-- 중복 리뷰 모달 -->
    <div id="duplicateReviewModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>이미 작성된 리뷰가 있습니다</h2>
        <p>해당 도서에 대한 리뷰를 이미 작성하셨습니다.<br />한 도서당 하나의 리뷰만 작성할 수 있습니다.</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="closeDuplicateModalBtn">확인</button>
        </div>
      </div>
    </div>

    <!-- 리뷰 로그인 필요 모달 -->
    <div id="reviewLoginRequiredModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>로그인 필요</h2>
        <p>리뷰를 작성하려면 로그인이 필요합니다.</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="reviewGoToLoginBtn">로그인하기</button>
          <button type="button" class="btn" id="reviewCancelLoginBtn">취소</button>
        </div>
      </div>
    </div>

    <!-- 리뷰 작성 성공 모달 -->
    <div id="reviewCreateSuccessModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>리뷰 작성 완료</h2>
        <p>리뷰가 성공적으로 작성되었습니다!</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="reviewCreateOkBtn">확인</button>
        </div>
      </div>
    </div>

    <!-- 리뷰 수정 성공 모달 -->
    <div id="reviewUpdateSuccessModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>리뷰 수정 완료</h2>
        <p>리뷰가 성공적으로 수정되었습니다!</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="reviewUpdateOkBtn">확인</button>
        </div>
      </div>
    </div>

    <!-- 리뷰 삭제 확인 모달 -->
    <div id="reviewDeleteConfirmModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>리뷰 삭제</h2>
        <p>정말로 이 리뷰를 삭제하시겠습니까?</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="reviewDeleteConfirmBtn">삭제</button>
          <button type="button" class="btn" id="reviewDeleteCancelBtn">취소</button>
        </div>
      </div>
    </div>

    <!-- 리뷰 삭제 성공 모달 -->
    <div id="reviewDeleteSuccessModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>리뷰 삭제 완료</h2>
        <p>리뷰가 성공적으로 삭제되었습니다!</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="reviewDeleteOkBtn">확인</button>
        </div>
      </div>
    </div>

    <!-- 장바구니 추가 성공 모달 -->
    <div id="cartSuccessModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>장바구니 추가 완료</h2>
        <p>상품이 장바구니에 추가되었습니다.</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="goToCartBtn">장바구니로 이동</button>
          <button type="button" class="btn" id="continueShoppingBtn">쇼핑 계속하기</button>
        </div>
      </div>
    </div>

    <!-- 로그인 필요 모달 -->
    <div id="loginRequiredModal" class="modal-overlay">
      <div class="modal-content">
        <button type="button" class="close-btn" aria-label="close">&times;</button>
        <h2>로그인 필요</h2>
        <p>장바구니에 상품을 추가하려면 로그인이 필요합니다.</p>
        <div class="modal-buttons">
          <button type="button" class="btn btn--primary" id="goToLoginBtn">로그인하기</button>
          <button type="button" class="btn" id="cancelLoginBtn">취소</button>
        </div>
      </div>
    </div>

    <!-- 4) 취소 및 환불 규정 패널 (고정 문구) -->
    <section class="panel" style="margin-top: 16px; margin-bottom: 30px">
      <h3 class="section-title" style="margin: 0 0 12px 0">취소 및 환불 규정</h3>

      <div class="policy">
        <ol class="policy-list">
          <li>
            <b>주문 취소</b>
            <ul class="policy-sub">
              <li>결제 완료 후에는 취소 요청을 접수해야 하며, 승인 여부에 따라 처리됩니다.</li>
            </ul>
          </li>

          <li>
            <b>환불 안내</b>
            <ul class="policy-sub">
              <li>환불은 결제 수단과 동일한 방법으로 처리됩니다.</li>
              <li>결제 완료 후 7영업일 이내에 환불이 완료되는 것을 목표로 합니다.</li>
              <li>부분 환불은 불가하며, 주문 전체를 취소하는 경우에만 환불 가능합니다.</li>
            </ul>
          </li>

          <li>
            <b>환불 불가 조건</b>
            <ul class="policy-sub">
              <li>배송 완료 후 책 상품은 상품 손상, 물리적 훼손 시 환불 불가합니다.</li>
            </ul>
          </li>

          <li>
            <b>마이페이지 &gt; 주문 내역 &gt; 취소/환불 요청</b>
            <ul class="policy-sub">
              <li>고객센터 문의: support@bookat.com 또는 02-1234-5678</li>
            </ul>
          </li>
          <li>
            <b>유의 사항</b>
            <ul class="policy-sub">
              <li>취소 및 환불 정책은 사정에 따라 변경될 수 있으며, 최신 내용은 사이트 공지 또는 주문 화면에서 확인 가능합니다.</li>
              <li>환불 시 발생하는 수수료는 결제 수단과 환불 방식에 따라 달라질 수 있습니다.</li>
            </ul>
          </li>
        </ol>
      </div>
    </section>
    <div th:replace="~{fragments/footer :: main-footer}"></div>
  </body>
</html>
